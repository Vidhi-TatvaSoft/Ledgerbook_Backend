@using LedgerBook.Constant
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor;

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "View Business";
}

<!-------------------- /customer details-------------------------------->
<div class="col-6  party-list border shadow p-0">
    <div class="row  border mx-0 p-3" id="total-amount-id">

    </div>

    <div class="row border mx-0 p-3">
        <div class="d-flex flex-column col-xl-4 col-md-12">
            <div class="fs-5 text-secondary ">Search For
                @HttpContextAccessor.HttpContext.Request.Cookies[TokenKey.PartyType]</div>
            <div class=""><input type="text" id="partySearch" class="form-control text-dark"
                    style="height:35px; width:100% !important;" placeholder="Search" />
            </div>
        </div>
        <div class="d-flex flex-column col-xl-4 col-md-6">
            <div class="fs-5 text-secondary ">Filter By</div>
            <div class="">
                <select name="" id="filterParty" class=" form-control">
                    <option value="-1">Select </option>
                    <option value="All">All</option>
                    <option value="Give">You'll Give</option>
                    <option value="Get">You'll Get</option>
                    <option value="Settled">Settled</option>
                </select>
            </div>

        </div>
        <div class="d-flex flex-column col-xl-4 col-md-6">
            <div class="fs-5 text-secondary ">Sort By</div>
            <div class="">
                <select name="" id="sortParty" class="form-control">
                    <option value="-1">Select</option>
                    <option value="mostRecent">Most Recent</option>
                    <option value="HighestAmount">Highest Amount</option>
                    <option value="LeastAmount">Least Amount</option>
                    <option value="ByName">By Name</option>
                    <option value="Oldest">Oldest</option>
                </select>
            </div>
        </div>
    </div>
    <input type="hidden" id="party-businessId">
    <input type="hidden" id="party-businessName">
    <input type="hidden" id="party-partyType">

    <div class="d-flex justify-content-between bg-light border mx-0 p-1 px-3">
        <div class="text-secondary fw-bold">Name</div>
        <div class="text-secondary fw-bold">Amount</div>
    </div>

    <div id="partyList-partial" class="party-list-scroll">

    </div>

    <div class="d-flex justify-content-center p-3 w-100">
        <div class="btn d-flex btn-primary add-party-button" data-bs-toggle="modal" data-bs-target="#save-party-modal"
            onclick="addPartyModal()"><i class="fa-solid fa-plus mt-1"></i>&nbsp; &nbsp; Add
            @HttpContextAccessor.HttpContext.Request.Cookies[TokenKey.PartyType]
        </div>
    </div>
    <input type="hidden" id="businessName">


</div>

<!------------------- transaction details-------------------------------->
<div class="col-6 party-list p-0" id="displaySelectedParty">
    <div class="d-flex flex-column justify-content-center align-items-center h-100">
        <div><img src="~/images/users.png" alt="" height="150px"></div>
        <div class="fs-4 text-secondary">No Party
            Selected</div>
    </div>
</div>

<!------------------------modal----------------------------------------------->
<div id="save-party-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered " id="save-party-modal-content">

    </div>
</div>

<div id="save-party-modal-innercontent" class="d-none">
    <div class="modal-content bg-light shadow-lg border-2">
        <div class="modal-header">
            <h5 class="modal-title" id="add-party-modal-title">Add Party</h5>
            <button type="button" class="btn-close usermodal-close-btn" data-bs-dismiss="modal"
                aria-label="Close"></button>
        </div>
        <form id="save-party-form-id">
            <div class="modal-body row">
                <div class="col-md-6 col-lg-6 col-xl-6 col-sm-12 col-12 mt-3">
                    <div class="form-floating ">
                        <input type="hidden" id="party-id">
                        <input type="text" oninput="RemoveWhiteSpace(this);partyNameValidation(this)"
                            onblur="TrimInput(this);partyNameValidation(this)" class="form-control" id="party-name"
                            placeholder="Party Name">
                        <label for="party-name" class="fs-6 text-secondary">Party Name*</label>
                        <span class="text-danger partyNameValidationMessage validationMessage"></span>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-6 col-sm-12 col-12 mt-3">
                    <div class="form-floating ">
                        <input type="text" oninput="RemoveWhiteSpace(this);emailValidation(this)"
                            onblur="TrimInput(this);emailValidation(this)" class="form-control" id="party-email"
                            placeholder="Email">
                        <label for="party-email" class="fs-6 text-secondary">Email*</label>
                        <span class="text-danger emailValidationMessage validationMessage"></span>
                    </div>
                </div>
                <div class=" col-8 mt-3 pe-0 d-none party-amount-div">
                    <div class="form-floating ">
                        <input type="Number" oninput="RemoveWhiteSpace(this);MinAmount(this)"
                            onblur="TrimInput(this);MinAmount(this)" class="form-control" id="party-amount"
                            placeholder="Opening Amount">
                        <label for="party-amount" class="fs-6 text-secondary">Opening Amount</label>
                        <span class="text-danger amountValidationMessage validationMessage"></span>
                    </div>
                </div>
                <div class=" col-4 mt-3 ps-0 d-none party-amount-div">
                    <div class="form-floating">
                        <select id="party-transactionType" class=" form-control">
                            <option value="@EnumHelper.TransactionType.GOT">You Got
                            </option>
                            <option value="@EnumHelper.TransactionType.GAVE">You Gave
                            </option>
                        </select>
                        <label for="party-transactionType">Type</label>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="fs-5"> Who are they?</div>
                    <div class="d-flex justify-content-start p-2">
                        <div class="form-check  me-3">
                            <input class="form-check-input" type="radio" name="flexRadioDefault" id="customer-radio"
                                checked>
                            <label class="form-check-label" for="customer-radio">
                                Customer
                            </label>
                        </div>

                        <div class="form-check ">
                            <input class="form-check-input" type="radio" name="flexRadioDefault" id="supplier-radio">
                            <label class="form-check-label" for="supplier-radio">
                                Supplier
                            </label>
                        </div>
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" onclick="saveParty()">Save </button>
                <button type="submit" class="btn btn-primary" onclick="saveParty();ClosePartyModal()">Save &
                    Close</button>
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </form>
    </div>
</div>

<div id="transaction-entry-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered " id="transaction-modal-content">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="save-transaction-modal-header">Add Transaction</h5>
                <button type="button" class="btn-close userdetail-confirmation-modal-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form id="save-transaction-entry-form">
                <div class="modal-body row ">
                    <input type="hidden" id="transaction-id">
                    <input type="hidden" id="transaction-partyId">
                    <div class=" col-8 mt-3 pe-0">
                        <div class="form-floating ">
                            <input type="Number" oninput="RemoveWhiteSpace(this);MinAmount(this)"
                                onblur="RemoveWhiteSpace(this);MinAmount(this)" class="form-control"
                                id="transaction-amount" placeholder="Opening Amount">
                            <label for="transaction-amount" class="fs-6 text-secondary">Amount</label>
                            <span class="text-danger amountValidationMessage validationMessage"></span>
                        </div>
                    </div>
                    <div class=" col-4 mt-3 ps-0">
                        <div class="form-floating">
                            <select id="transaction-transactionType" class="form-control">
                                <option value="@EnumHelper.TransactionType.GOT">You Got
                                </option>
                                <option value="@EnumHelper.TransactionType.GAVE">You Gave
                                </option>
                            </select>
                            <label for="transaction-transactionType">Type</label>
                        </div>
                    </div>
                    <div class=" col-6 mt-3 ">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="transaction-duedate">
                            <label for="transaction-duedate">Due date</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary" onclick="closeTransactionModal()">Save</button>
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </form>

        </div>
    </div>
</div>

<div id="delete-entry-modal" class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="add-user-modal-title">Delete transaction confirmation</h5>
                <button type="button" class="btn-close user-delete-modal-close-btn" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body ">
                <div class="delete-cat-image d-flex flex-column  align-items-center">
                    <p>Are you sure you want to delete this transaction?</p>
                    <input type="hidden" id="delete-transaction-id">
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <a type="button" class="btn btn-primary" onclick="deleteTransaction()">Yes</a>
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>

<!----------------------------- partial views ------------------------------->


@section Scripts {
    <script>
        let searchText = $("#partySearch").val();
        let filter = $("#filterParty").val();
        let sort = $("#sortParty").val();
        
        $(document).ready(function () {
            displayPartyList();

            $(document).on("submit", "#save-party-form-id", function (e) {
                e.preventDefault();
            })
            $(document).on("submit", "#save-transaction-entry-form", function (e) {
                e.preventDefault();
                if (validateSaveTransactionForm()) {
                    let formData = new FormData();
                    formData.append("PartyId", $("#transaction-partyId").val())
                    formData.append("TransactionId", $("#transaction-id").val() == "" ? 0 : $("#transaction-id").val())
                    formData.append("TransactionAmount", $("#transaction-amount").val())
                    formData.append("TransactionTypeEnum", $("#transaction-transactionType").val())
                    formData.append("DueDate", $("#transaction-duedate").val())
                    let params = setBusinessParameter("/Party/SaveTransactionEntry", POST, null, FORMDATA, formData, saveTransactionSuccess);
                    $("body").addClass("loading");
                    ajaxCall(params);
                }
            })

            $(document).on('hidden.bs.modal', "#save-party-modal", function (e) {
                emptyInputValidation("save-party-form-id")
                RemoveValidations();
                displayPartyList();
            })

            $(document).on('hidden.bs.modal', "#transaction-entry-modal", function (e) {
                emptyInputValidation("save-transaction-entry-form")
                RemoveValidations();
            })

            $(document).on("change", "#filterParty", function () {
                filter = $(this).val();
                displayPartyList(searchText, filter, sort)
            })

            $(document).on("change", "#sortParty", function () {
                sort = $(this).val();
                displayPartyList(searchText, filter, sort)
            })

        })

        var displaytime = window.setInterval(function () {
            partyTimeDisplay()
        }, 10000);

        function debounce(func, delay) {
            let timeoutId; // Variable to store the timer ID

            return function (...args) {
                clearTimeout(timeoutId);

                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        const handleSearch = (event) => {
            let searchText = event.target.value;
            displayPartyList(searchText, filter, sort)
        };

        const debouncedSearch = debounce(handleSearch, 500);
        const searchInput = document.getElementById('partySearch');
        searchInput.addEventListener('input', debouncedSearch);

        //to displat list off all parties by partytype
        function displayPartyList(searchText = "", filter, sort) {
            let partyType = getCookie(Party_Type);
            let params = setBusinessParameter("/Party/GetAllParties", GET, null, FORM_URL, { partyType: partyType, searchText: searchText, filter: filter, sort: sort }, getAllPartiesSuccess);
            $("body").addClass("loading");
            ajaxCall(params);
        }
    </script>
}